<!DOCTYPE html >

<html >
  <head >
    <title >ultimate tic-tac-toe</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" ></script>
    <link rel="stylesheet" type="text/css" href="/p/uttt/res?f=css/game.css" />
  </head>
  <body >
    <div class="header" >
      <div class="wrap" >You are <span class="player" ></span> and it is <span class="turn" ></span></div>
      <div class="notify_link" >Share the link below with your opponent</div>
      <input class="copy_link" />
      <div class="alertbox"></div>
    </div>
    <div class='global' >
      <div class='local' data-local="0" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>
      <div class='local' data-local="1" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>
      <div class='local' data-local="2" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>
      <div class='local' data-local="3" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>
      <div class='local' data-local="4" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>
      <div class='local' data-local="5" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>
      <div class='local' data-local="6" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>
      <div class='local' data-local="7" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>
      <div class='local' data-local="8" >
        <div class='cell' data-cell="0" ></div>
        <div class='cell' data-cell="1" ></div>
        <div class='cell' data-cell="2" ></div>
        <div class='cell' data-cell="3" ></div>
        <div class='cell' data-cell="4" ></div>
        <div class='cell' data-cell="5" ></div>
        <div class='cell' data-cell="6" ></div>
        <div class='cell' data-cell="7" ></div>
        <div class='cell' data-cell="8" ></div>
      </div>

    </div>
    <script >

      var scale = 'scale(1)';
      document.body.style.webkitTransform =  scale
      document.body.style.msTransform =   scale
      document.body.style.transform = scale

      var alert = function(msg) {
        $('.alertbox').css('background-color', 'red')
        $('.alertbox').css('color', '#eee')
        $('.alertbox').html(msg)
        setTimeout(function() {
          $('.alertbox').css({'background-color': 'white'})
          $('.alertbox').css({'color': 'white'})
        }, 2000)

      }

      var getParameterByName = function(name) {
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(window.location.href);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      var player = getParameterByName('player')
      $('.player').text(player)
      if (player == 'x') {
        $('.copy_link').val('https://stapinski.co/p/uttt/game?player=o&game_name=' + getParameterByName('game_name'))
      } else {
        $('.copy_link').val('https://stapinski.co/p/uttt/game?player=x&game_name=' + getParameterByName('game_name'))
      }

      $('.cell').click(function(e) {
        e.preventDefault()

        var local = $(this).parent().data('local')
        var cell = $(this).data('cell')

        $.ajax({
          url: 'https://stapinski.co/p/uttt/api/game/move',
          type: 'post',
          data: {
            game_name: getParameterByName('game_name'),
            player: getParameterByName('player'),
            local: local,
            cell: cell
          },
          success: function(data) {
            if (data.status == 200) {
              updateBoard()
            } else {
              alert(data.payload.message)
            }
          }
        })
      })

      var updateBoard = function() {

        if (sessionStorage.getItem('log_id') == null) {
          sessionStorage.setItem('log_id', 0)
        }

        $.ajax({
          url: 'https://stapinski.co/p/uttt/api/game/update',
          type: 'post',
          data: {
            game_name: getParameterByName('game_name'),
            log_id: sessionStorage.getItem('log_id')
          },
          success: function(data) {
            if (data.status == 200) {

              sessionStorage.setItem('log_id', data.payload.log_id)

              if (data.payload.winner != undefined) {
                alert('Game has ended! '+ data.payload.winner +' won!')
                clearInterval(updateInterval)
              }

              if (data.payload.player == getParameterByName('player')) {
                $('.turn').text('your turn')
              } else {
                $('.turn').text('not your turn')
              }

              if (data.payload.next_local_has_to_be != null) {
                $('.global .local .cell').removeClass('valid')
                $('.global > .local:nth-child('+ (data.payload.next_local_has_to_be+1) +') > .cell').addClass('valid')
              } else {
                $('.global .local .cell').addClass('valid')
              }

              for (var i = 0; i < 9; i++) {
                for (var j = 0; j < 9; j++) {
                  if (data.payload.state[i][j] != null) {
                    $('.global > .local:nth-child('+ (i+1) +') > .cell:nth-child('+ (j+1) +')').html(data.payload.state[i][j])
                  }
                }

                if (data.payload.board[i] == 'o') {
                  $('.global > .local:nth-child('+ (i+1) +') > .cell').addClass('o')
                  $('.global > .local:nth-child('+ (i+1) +') > .cell:nth-child(5)').removeClass('o')

                } else if (data.payload.board[i] == 'x') {
                  $('.global > .local:nth-child('+ (i+1) +') > .cell:nth-child(2n+1)').addClass('x')
                } else if (data.payload.board[i] == 'n') {
                  $('.global > .local:nth-child('+ (i+1) +') > .cell').addClass('closed')
                }
              }

            } else if (data.status != 204) {
              alert(data.payload.message)
            }
          }
        })
      }

      var updateInterval = setInterval(updateBoard, 1000)
      sessionStorage.setItem('log_id', 0)
      updateBoard()
      $('.update').click(updateBoard)

    </script>
  </body>
</html>
